<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RANDOMPHOTO</title>
<style>
  body { font-family: Arial; background: #000; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin:0; padding:20px;}
  button { padding: 12px 20px; margin: 10px; background: crimson; border:none; border-radius: 8px; color: white; cursor: pointer; font-size: 1.1rem; }
  button:hover { background: darkred; }
  .hidden { display: none; }
  form { display: flex; flex-direction: column; max-width: 350px; width: 100%; margin-top: 30px; }
  input { margin: 8px 0; padding: 10px; border-radius: 5px; border:none; font-size: 1rem; }
  #camera-section { margin-top: 30px; text-align: center; }
  video { width: 320px; height: 240px; border-radius: 12px; background: black; }
  #logout-btn { margin-top: 15px; }
  #error-msg { color: #f44336; font-weight: bold; margin-top: 10px; min-height: 1.3em; }
</style>
</head>
<body>

<div id="auth-choice">
  <button id="btn-login">Iniciar Sesión</button>
  <button id="btn-register">Registrarse</button>
</div>

<form id="form-login" class="hidden">
  <h2>Iniciar Sesión</h2>
  <input type="email" id="login-email" placeholder="Correo electrónico" required />
  <input type="password" id="login-password" placeholder="Contraseña" required />
  <button type="submit">Entrar</button>
  <div id="login-error" role="alert"></div>
  <button type="button" id="cancel-login">Cancelar</button>
</form>

<form id="form-register" class="hidden">
  <h2>Registrarse</h2>
  <input type="email" id="register-email" placeholder="Correo electrónico" required />
  <input type="password" id="register-password" placeholder="Contraseña" required />
  <input type="text" id="register-username" placeholder="Nombre de usuario" required />
  <button type="submit">Registrarse</button>
  <div id="register-error" role="alert"></div>
  <button type="button" id="cancel-register">Cancelar</button>
</form>

<div id="camera-section" class="hidden">
  <h2>Bienvenido, <span id="user-name"></span></h2>
  <video id="video" autoplay playsinline></video>
  <br />
  <button id="logout-btn">Salir</button> <!-- Aquí cambié el texto -->
</div>

<script src="https://cdn.jsdelivr.net/npm/appwrite@8.0.0/build/appwrite.min.js"></script>
<script>
  // Configura tu proyecto Appwrite aquí
  const sdk = new window.Appwrite();
  sdk
    .setEndpoint('https://nyc.cloud.appwrite.io/v1') // Cambia si tienes otro endpoint
    .setProject('685ef5dd0010e2c90647'); // Cambia al ID de tu proyecto

  const account = new window.Appwrite.Account(sdk);

  // Referencias a elementos
  const authChoice = document.getElementById('auth-choice');
  const btnLogin = document.getElementById('btn-login');
  const btnRegister = document.getElementById('btn-register');

  const formLogin = document.getElementById('form-login');
  const loginEmail = document.getElementById('login-email');
  const loginPassword = document.getElementById('login-password');
  const loginError = document.getElementById('login-error');
  const cancelLogin = document.getElementById('cancel-login');

  const formRegister = document.getElementById('form-register');
  const registerEmail = document.getElementById('register-email');
  const registerPassword = document.getElementById('register-password');
  const registerUsername = document.getElementById('register-username');
  const registerError = document.getElementById('register-error');
  const cancelRegister = document.getElementById('cancel-register');

  const cameraSection = document.getElementById('camera-section');
  const video = document.getElementById('video');
  const logoutBtn = document.getElementById('logout-btn');
  const userNameSpan = document.getElementById('user-name');

  let stream = null;

  // Mostrar formularios
  btnLogin.onclick = () => {
    authChoice.classList.add('hidden');
    formRegister.classList.add('hidden');
    formLogin.classList.remove('hidden');
    loginError.textContent = '';
    formLogin.reset();
  };

  btnRegister.onclick = () => {
    authChoice.classList.add('hidden');
    formLogin.classList.add('hidden');
    formRegister.classList.remove('hidden');
    registerError.textContent = '';
    formRegister.reset();
  };

  cancelLogin.onclick = () => {
    formLogin.classList.add('hidden');
    authChoice.classList.remove('hidden');
  };

  cancelRegister.onclick = () => {
    formRegister.classList.add('hidden');
    authChoice.classList.remove('hidden');
  };

  // Iniciar cámara
  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    } catch (err) {
      alert('No se pudo acceder a la cámara: ' + err.message);
    }
  }

  // Detener cámara
  function stopCamera() {
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
  }

  // Mostrar cámara y ocultar demás
  function showCamera(userName) {
    formLogin.classList.add('hidden');
    formRegister.classList.add('hidden');
    authChoice.classList.add('hidden');
    cameraSection.classList.remove('hidden');
    userNameSpan.textContent = userName;
    startCamera();
  }

  // Ocultar cámara y mostrar elección auth
  function showAuthChoice() {
    cameraSection.classList.add('hidden');
    authChoice.classList.remove('hidden');
    stopCamera();
  }

  // Registrar usuario
  formRegister.onsubmit = async (e) => {
    e.preventDefault();
    registerError.textContent = '';
    try {
      // Crear cuenta
      await account.create(
        window.crypto.randomUUID(),
        registerEmail.value,
        registerPassword.value,
        registerUsername.value
      );
      // Iniciar sesión luego del registro
      await account.createSession(registerEmail.value, registerPassword.value);
      showCamera(registerUsername.value);
    } catch (error) {
      if(error.message.includes('already exists')){
        registerError.textContent = 'El correo ya está registrado.';
      } else {
        registerError.textContent = 'Error: ' + error.message;
      }
    }
  };

  // Login
  formLogin.onsubmit = async (e) => {
    e.preventDefault();
    loginError.textContent = '';
    try {
      await account.createSession(loginEmail.value, loginPassword.value);
      const user = await account.get();
      showCamera(user.name || 'Usuario');
    } catch (error) {
      loginError.textContent = 'Credenciales incorrectas.';
    }
  };

  // Logout
  logoutBtn.onclick = async () => {
    try {
      await account.deleteSession('current');
    } catch {}
    showAuthChoice();
  };

  // Comprobar sesión al cargar la página
  window.onload = async () => {
    try {
      const user = await account.get();
      showCamera(user.name || 'Usuario');
    } catch {
      showAuthChoice();
    }
  };
</script>
</body>
</html>

